version: "3"
services:
  skaha:
    container_name: skaha
    ports:
      - "8081:8080"
    image: skaha:latest # build the image manually, context can not be applied here
    # build:
    #   context: ./dependencies/science-platform/skaha
    #   dockerfile: Dockerfile
    environment:
      - skaha.usersgroup=ivo://cadc.nrc.ca/gms?mini-src-test-group
      - skaha.homedir=/arc/home
    volumes:
      - ./configs/skaha:/config:ro
    links:
      - reg
      - gms
      - etcd0
    depends_on:
      - reg
      - gms
      - etcd0
    networks:
      - science-platform
  reg:
    container_name: reg
    image: reg:latest # build the image manually, context can not be applied here
    # build:
    #   context: ./dependencies/reg/reg
    #   dockerfile: Dockerfile
    volumes:
      - ./configs/reg:/config:ro
    networks:
      - science-platform
  gms:
    container_name: gms
    build:
      context: ./dependencies/group-membership-service 
      dockerfile: Dockerfile
    environment:
      - IAM_HOST=http://iam:8080/
      - GMS_APPLICATION_LOGGING_LEVEL=DEBUG
      - TOMCAT_CONNECTOR_SCHEME=http
      - TOMCAT_CONNECTOR_PROXY_NAME=gms
      - TOMCAT_CONNECTOR_PROXY_PORT=8080
    links:
      - iam
    networks:
      - science-platform
    depends_on:
      - iam
  etcd0:
    image: quay.io/coreos/etcd:v3.5.0
    command:
      etcd --name etcd0
           --initial-advertise-peer-urls http://etcd0:2380
           --listen-peer-urls http://0.0.0.0:2380
           --advertise-client-urls http://etcd0:2379
           --listen-client-urls http://0.0.0.0:2379
           --initial-cluster-token etcd-cluster-1
           --initial-cluster etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
           --initial-cluster-state new
    ports:
      - 2379:2379
    volumes:
      - etcd0-data:/etcd-data
    networks:
      - science-platform  
  etcd1:
    image: quay.io/coreos/etcd:v3.5.0
    command:
      etcd --name etcd1
           --initial-advertise-peer-urls http://etcd1:2380
           --listen-peer-urls http://0.0.0.0:2380
           --advertise-client-urls http://etcd1:2379
           --listen-client-urls http://0.0.0.0:2379
           --initial-cluster-token etcd-cluster-1
           --initial-cluster etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
           --initial-cluster-state new
    volumes:
      - etcd1-data:/etcd-data
    networks:
      - science-platform  
  etcd2:
    image: quay.io/coreos/etcd:v3.5.0
    command:
      etcd --name etcd2
           --initial-advertise-peer-urls http://etcd2:2380
           --listen-peer-urls http://0.0.0.0:2380
           --advertise-client-urls http://etcd2:2379
           --listen-client-urls http://0.0.0.0:2379
           --initial-cluster-token etcd-cluster-1
           --initial-cluster etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
           --initial-cluster-state new
    volumes:
      - etcd2-data:/etcd-data
    networks:
      - science-platform
  db:
    container_name: db
    restart: unless-stopped
    image: mysql
    ports:
      - "3306:3306"
    # volumes:
    #   - ./data.sql:/data.sql
    # command: --init-file /data.sql
    environment:
      MYSQL_ROOT_PASSWORD: pwd
      MYSQL_USER: iam
      MYSQL_PASSWORD: pwd
      MYSQL_DATABASE: iam
    networks:
      - science-platform
  iam:
    ports:
      - "8080:8080"
    container_name: iam
    image: indigoiam/iam-login-service # build the image manually, context can not be applied here
    # build:
    #   context: ./dependencies/iam/iam-login-service/docker
    #   dockerfile: Dockerfile
    environment:
      - IAM_HOST=localhost:8080
      - IAM_BASE_URL=http://localhost:8080
      - IAM_ISSUER=http://localhost:8080
      - IAM_DB_ALLOW_PUBLIC_KEY=true
      - IAM_FORWARD_HEADERS_STRATEGY=native
      - IAM_DB_HOST=db
      - IAM_DB_NAME=iam
      - IAM_DB_USERNAME=root
      - IAM_DB_PASSWORD=pwd
      - IAM_KEY_STORE_LOCATION=file:/keystore/keystore.jwks
      - IAM_X509_CAN_LOGIN=true
      - IAM_LOG_LEVEL=DEBUG
      - IAM_JAVA_OPTS=-Dspring.profiles.active=prod,registration,oidc -Djava.security.egd=file:/dev/./urandom
    volumes:
      - ./configs/iam:/keystore:ro
      - ./data.sql:/indigo-iam/WEB-INF/classes/data.sql
    depends_on:
      - db
    networks:
      - science-platform
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://iam:8080/.well-known/openid-configuration"]
      interval: 3s
      timeout: 3s
      retries: 10
volumes:
  logs:
  db_data:
  etcd0-data:
  etcd1-data:
  etcd2-data:
networks:
  science-platform:
